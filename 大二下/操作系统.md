# 操作系统

## 1.第一章

### 1.1操作系统定义

**操作系统定义1**：操作系统是一组**控制**和**管理**计算机**软硬件资源**、合理地对各类**作业**进行**调度**以及**方便用户使用**的程序集合

**操作系统定义2**：·操作系统是位于**硬件层**（HAL)之上，所有其它**系统软件层**之下的一个**系统软件**，使得管理系统中的各种软件和硬件资源得以充分利用，方便用户使用计算机系统

### 1.2操作系统目标和作用

**操作系统的目标**：

1. **方便性**：操作系统使计算机更易于使用。
2. **有效性**：操作系统允许以更有效的方式使用计算机系统资源。
   - 提高系统资源利用率
   - 提高系统的吞吐量
3. **可扩展性**：在操作系统中，允许有效地开发，测试和引进新的系统功能。
4. **开放性**：实现应用程序的可移植性和互操作性，要求具有统一的开放的环境。

**操作系统的作用**：

1. 作为用户与计算机硬件系统之间的接口

   - 计算机用户需要的**用户命令**：由OS实现的所有用户命令所构成的集合被称为OS的**用户接口**或**命令接口**
     - 字符形式
     - 菜单形式
     - 图形形式
   - 应用软件需要的**系统调用**：由OS实现的所有系统调用所构成的集合称为**程序接口**或**应用编程接口API**

2. 作为资源管理者的操作系统

   - 处理机管理，用于分配和控制处理机
   - 存储器管理，主要负责内存的回收与分配
   - I/O设备管理，负责I/O设备的分配与操纵
   - 文件管理，负责文件的存取、共享和保护

   操作系统的任务在**相互竞争**的程序之间**有序**地控制对硬件设备的分配

   对于**多用户系统**，需要管理**共享资源**，以下两种方式实现**多路复用资源**：

   - **在时间上复用**：当一种资源在时间上复用，不同的进程轮流使用它；例如CPU、打印机等
   - **在空间上复用**：每个客户得到资源的一部分；例如内存、磁盘等

3. 作为扩展机器的操作系统

**裸机**：完全无软件的计算机系统

**扩充机器**：覆盖软件的机器称为扩充机器或虚机器

![image-20250331111849562](操作系统.assets/image-20250331111849562.png)

### 1.3OS发展过程

1. **人工操作方式**：未配置操作系统，穿孔卡片输入输出

2. **脱机输入输出方式**：未配置操作系统，在**外围机**控制下实现输入输出，主要解决CPU与设备不匹配矛盾

3. **单道批处理系统**：内存中仅有一道作业，结束或出错才会调用另一个作业

   - **特征**：自动性、顺序性、单道性
   - **优点**：减少人工操作、解决作业自动接续
   - **缺点**：平均周转时间长，咩有交互能力

4. **多道批处理系统**：内存中存放**多道**作业运行

   - **特征**：多道性、无序性、调度性

   - **优点**：提高CPU的利用率，提高内存和I/O设备利用率，增加系统吞吐量

   - **缺点**：平均周转时间长，没有交互能力

   - **需要解决的问题**：

     - **处理机管理**：分配和控制CPU
     - **存储器管理**：内存分配与回收
     - **I/O设备管理**：I/O设备的分配与操纵
     - **文件管理**：文件的存取、共享和保护
     - **作业管理**：如何组织作业运行

     ![image-20250331113231887](操作系统.assets/image-20250331113231887.png)

5. **分时操作系统**：用户需要**人机交互**、**共享主机**、**便于用户上机**

   - **关键问题**：
     - 及时接受：实现多个用户的信息及时接收
     - 及时处理：及时控制作业的运行
   - **实现方法**：
     - 简单分时系统
     - 具有前台和后台的分时系统
     - 多道分时系统
   - **特点**：
     - 多路性：一个主机与多个终端相连
     - 独立性：彼此独立操作、互不干扰
     - 及时性：系统能在很短时间得到回答
     - 交互性：能实现人机对话（**区别于批处理系统**）

6. **实时系统**：计算机及时响应**外部事件的请求**，在规定时间内完成处理、控制所有**实时设备**和**实时任务**协调运行

   - **实时任务类型**：
     - 按是否为**周期性**划分：周期性实时任务、非周期性实时任务
     - 按**截止时间**划分：硬实时任务，软实时任务
   - **特征**：
     - **多路性**：能对多个对象进行控制
     - **独立性**：独立运行，不混淆不破坏
     - **交互性**：仅限于访问系统中某些特定的专用服务程序
     - **可靠性**：高可靠性，具有多级容错防护能力
     - **及时性**：不同系统要求不同，控制对象在截止时间内完成

### 1.4现代操作系统基本特征 

1. **并发性**（最重要）
   - 并发性：多个事件在同一**时间间隔**内发生
   - 并行性：多个事件在同一**时刻**内发生
   - **程序**：静态实体
   - **进程**：进程是程序的**执行过程**,是系统进行**资源分配**和**调度**的一个**独立单位**
   - **线程**：作为**独立运行**和**调度**的基本单位
2. 共享性（仅次于并发）
   - **共享**：系统中的资源可供内存中多个**并发执行**的进程共同使用
   - **互斥共享**：把在一段时间内只允许一个进程访问的资源称为**临界资源**（打印机），临界资源可以供给多个进程使用，但**一段时间**内只允许**一个**进程使用
   - **同时访问**：多个任务可以**同时使用**系统中的软硬件资源；多个进程**交替互斥**地使用系统资源（磁盘）
3. 虚拟性
   - **虚拟**：通过某种技术把一个物理实体映射为若干个逻辑上地对应物
   - **时分复用技术**：虚拟处理机分时实现
   - **空分复用技术**：虚拟磁盘技术
4. 异步性
   - **执行结果不确定**，程序不可再现
   - **异步性**，多道程序环境下程序以异步方式执行，每道程序在何时执行、完成都不确定

### 1.5操作系统的主要功能

1. **处理机管理**：按照一定的算法把处理及分配给进程，并对其进行有效的管理和控制
   - 进程控制
   - 进程同步与互斥
   - 进程通信
   - 进程调度
2. **存储器管理**：方便用户使用存储器，提高存储器利用率以及从逻辑上扩充内存
   - 内存分配
   - 内存保护
   - 地址映射
   - 内存扩充
3. **设备管理**：完成用户提出的I/O请求；为进程分配所需的I/O设备；提高CPU和I/O设备的利用率；提高I/O速度；方便用户使用I/O设备
   - **缓冲管理**：有效缓和CPU和I/O设备速度不匹配的矛盾，提高CPU利用率
   - **设备分配**：根据I/O请求，分配所需的设备
   - **设备处理**：设备处理程序被称为设备驱动程序
4. **文件管理**：对用户的文件和系统文件进行管理，以方便用户使用，并确保文件的安全性
   - 文件存储空间的管理
   - 目录管理
   - 文件的读写管理与保护
5. **方便用户使用用户接口**

### 1.6OS结构设计

1. **无结构操作系统**：只注意功能实现与效率，缺乏首尾一致思想

   - 设计出的操作系统庞大又杂乱，缺乏清晰的结构
   - 程序错误很多，调试困难

2. **模块式结构**：

   - **模块之间的关系**：所有各块的实现均可以任意引用其他各块所提供的概念及属性
   - **优点**：提高OS设计的正确性，增强OS的可适应性、加速OS的开发过程
   - **缺点**：对模块互粉以及对接口的规定精确描述很困难；从功能划分模块，未能区别共享资源和独占资源

3. **层次式结构**

   - **层相互关系**：各层的实现不依赖其上层所提供的概念和属性，只依赖下层；每一层军对其上层隐藏下层
   - **考虑因素**：
     - 程序嵌套：通常一个功能并非一个程序，而是若干软件层才能实现
     - 运行频率：将经常活跃的模块放在最接近硬件的层
     - 公共模块：把供多种资源管理程序调用的公共模块设置在最底层，方便调用
     - 用户接口：命令接口、程序接口设置在最高层，直接供用户使用
   - **客户/服务器模式**
     - **优点**：提高系统可扩展性、增强系统可靠性、可移植性好、提供对分布式系统的支持
     - **缺点**：运行效率有所降低（消息传递开销+模式切换开销）
   - **面向对象的程序设计技术OOP**
     - 可修改性和可扩充性
     - 继承性
     - 正确性和可靠性

4. **微内核结构**

   **微内核技术**是指能实现现代OS核心功能的小型内核，更小更精炼，不仅运行在**核心态**，而且开机后常驻内存，不会因为内存紧张而被换出内存

   ![image-20250331232823901](操作系统.assets/image-20250331232823901.png)

   - **内核**：操作系统最基本最核心的部分，实现操作系统内核功能的程序就是**内核程序**
     - **时钟管理**：用时钟中断实现计时功能
     - **原语**：一种特殊的程序，具有原子性，**不可被中断**
     - 时钟管理、中断处理、原语等与**硬件**相关一定在**内核**；进程管理、存储器管理等对**数据结构**操作不涉及硬件，有的操作系统不会放到内核
     - ![image-20250331232608832](操作系统.assets/image-20250331232608832.png)
   - **外核操作系统**
     - 颠覆传统操作系统设计的架构，将**资源管理**与**资源保护**分离，赋予**应用程序更大的灵活性**和**对硬件的直接控制权**
     - ![image-20250331233022595](操作系统.assets/image-20250331233022595.png)
     - ![image-20250331233214504](操作系统.assets/image-20250331233214504.png)

## 2.进程管理

### 2.1程序执行

**顺序执行特征**：

- **顺序性**：处理机的操作严格按照**程序所规定的顺序**执行
- **封闭性**：程序运行时**独占全机资源**，程序一旦开始执行，其执行结果不受外界因素影响
- **可再现性**：只要程序执行时环境和初始条件相同，都将获得**相同的结果**（无论是不是停停走走）

**并发执行特征**：

- **间断性**：由于共享系统资源，形成相互制约关系，导致并发程序具有“**执行-暂停-执行**”这种间断性的规律
- **失去封闭性**：多个程序**共享资源**，资源状态由多个程序改变，程序运行失去封闭性
- **不可再现性**：程序并发执行**失去封闭性**，导致不可再现

### 2.2进程描述

**进程特征**：

1. **结构特征**：为了使程序独立运行，应为之配置一进程控制块**PCB**；由**程序段**、**相关数据段**、**PCB**构成进程实体；所谓创建进程实质上是创建进程实体中的**PCB**，撤销进程同理。
2. **动态性**：进程的实质是**进程实体**的一次执行过程，动态性表现“**由创建而产生，由调度而执行，由撤销而消亡**”
3. **并发性**：多个进程实体同存在**内存**中，且在一段时间内**同时运行**
4. **独立性**：进程实体是一个能**独立运行**、**独立分配资源**和**独立接受调度**的基本单位
5. **异步性**：进程按各自独立的、不可预知的速度向前推进，按**异步方式**运行

**进程与程序的主要区别**：

![image-20250401173639679](操作系统.assets/image-20250401173639679.png)

**进程基本状态及转换**：

1. **进程转状态**：

   - **就绪状态**：进程分配到除CPU以外的所有必要资源，一旦得到CPU便可立即执行
   - **执行状态**：进程获得CPU，程序正在执行
   - **阻塞状态**：正在执行的进程由于发生某件事而暂时无法执行，放弃处理机处于暂停状态（读磁盘）
   - 新建状态：进程被创建，但未被OS接纳为可执行进程，**程序在辅存中**，**PCB在内存中**
   - 终止状态：因停止被OS从执行状态释放
   - **挂起状态**：使执行的进程暂停执行、静止下来（**换到外存中**）

   ![image-20250401231147579](操作系统.assets/image-20250401231147579.png)

2. 多个进程竞争内存资源解决办法

   - 采用交换技术：换出一部分进程到外存，腾出内存空间
   - 采用虚拟存储技术：每个进程只能装入一部分程序和数据

3. **进程控制块**：常驻**内存**，是**进程存在**的唯一标识

   - **作用**：
     - 作为**独立运行基本单位**的标志
     - 能实现**间断性**运行方式
     - 提供**进程管理**所需的信息
     - 提供**进程调度**所需的信息
     - 实现与**其他进程**的同步与通信
   - **信息**：
     - **进程标识符PID**：内部标识符（系统），外部标识符（用户）
     - **处理机状态**：寄存器，PSW，PC，栈指针
     - **进程调度信息**：进程状态，优先级，阻塞原因
     - **进程控制信息**：程序和数据的地址、进程同步和通信机制、资源清单
   - **组织方式**：
     - **线性方式**：所有PCB组织在一张线性表中，该表的首地址放在专用区域
     - **链接方式**：把具有同一状态的PCB用其中的链接字连接成一个队列，排成**就绪队列**，若干个**阻塞队列**以及**空白队列**
     - **索引方式**：根据所有进程的状态建立几张索引表

### 2.3进程控制

**进程控制**是进程管理中最基本的功能，其负责**进程的创建**、**进程的中止**、**进程的阻塞与唤醒**，进程控制一般是由OS内核中的**原语**来实现。

1. 进程创建
   - **事件**
     - **用户登录**：登陆成功为用户创建一个基础南横，插入到就绪队列
     - **作业调度**：多道批处理系统当作业调度程序按照一定算法调度到某个作业会将他们装入内存，创建进程并插入到就绪队列
     - **提供服务**：用户程序提出某种请求，系统创建一个进程为用户程序提供所需的服务
     - **应用请求**：用户自己创建新进程使得并发执行完成特定任务
   - **步骤**
     - 申请空白PCB
     - 为新进程分配资源
     - 初始化进程控制块：初始化标识信息，初始化处理机状态信息，初始化处理机控制信息
     - 将新进程插入就绪队列
2. 进程的终止
   - **事件**
     - 正常结束
     - 异常结束：越界错、保护错、指令错、特权指令错、运行超时、算术错
     - 外界干预：操作员或OS干预、父进程请求、父进程中止
   - **步骤**
     - 根据被终止进程的**标识符**，从PCB集合中检索出该进程的PCB，并读出该进程的状态
     - 若被终止进程正处于**执行状态**，则立即中止该进程的执行，并置**调度标志**为真，以指示该进程被终止后应重新调度
     - 若该进程还有**子孙进程**，中止其所有子孙进程，防止其成为不可控的进程
     - 将被中止进程所拥有的全部资源或归还给其**父进程**，或归还给**系统**
     - 将被终止进程的**PCB**从所在**队列**中移出，等待其他程序来搜索信息
3. 进程的阻塞与唤醒
   - **事件**
     - **向系统请求共享资源失败**
     - **等待某种操作完成**
     - **新数据尚未到达**
     - **等待新任务的到达**
   - **阻塞过程**（block()）
     - 正在执行的程序发生上述事件由于无法继续执行，于是进程通过调用**阻塞原语**block()把自己阻塞
     - 把进程控制块中的现行状态由“**执行**”改为“**阻塞**”，并将PCB插入阻塞队列
     - 转**调度程序**进行重新调度，将处理机分配给另一就绪程序，并进行切换
   - **唤醒过程**(wakeup())
     - 把被阻塞的进程从等待该事件的**阻塞队列**中移除，将其PCB中现行状态由**阻塞**改为**就绪**
     - 将该PCB插入到就绪队列中
4. 进程的挂起与激活
   - **进程挂起**（suspend（））
     - 检查被挂起进程的状态，若处于**活动就绪**状态，将其改为**静止就绪**
     - 对于**活动阻塞**状态的进程，改为**静止阻塞**
   - **进程激活**（active（））
     - 先将进程从外存调入内存，检查进程的现行状态
     - 若是**静止就绪**，改为**活动就绪**；若是**静止阻塞**，改为**活动阻塞**

### 2.4进程同步

**主要任务**：使并发执行的进程之间有效地共享资源和相互合作，从而使程序的执行具有可再现性

**分类**：同步关系（直接制约，保证进程之间操作的先后次序的约束）；互斥关系（间接制约，强调对共享资源的互斥访问）

**临界资源**：一次只允许一个进程访问的资源

**遵循规则**：空闲让进，忙则等待，有限等待，让权等待

**解决临界区互斥的方法**

1. ​	硬件同步机制（硬件为每个临界区上一个锁）
   - **优点**
     - 适用于任意数目的进程，再单处理器或多处理器上
     - 简单，容易验证其正确性
     - 可以支持进程内存在多个临界区，只需为每个临界区设置一个布尔变量
   - **缺点**
     - 等待耗费CPU事件，不能实现**让权等待**
     - 可能**饥饿**，从等待进程中随机选一个进临界区，有的进程可能一直选不上
2. 信号量机制（从进程管理者角度解决互斥问题）
   - **整型信号量**：S.value>0，标识某资源的数目，也称为资源信号量
   - **记录型信号量**：如果S.value<0，则其绝对值标识等待队列中的进程个数
     - **优点**：简单，表达能力强
     - **缺点**：不够安全，PV操作使用不当会出现死锁；只能用于共享一个临界资源
   - **AND型信号量**：将所有资源分配给进程，只要有一个没用完，其他也不准分配
   - **信号量集**：每次分配时采用**信号量集**控制，分配多个资源

### 2.5进程通信

**定义**：进程之间的信息交换

**分类**：

- **低级通信**：效率低；通信对用户不透明
- **高级通信**：直接利用**操作系统**所提供的一组通信命令，高效地传送大量数据地通信方式，效率高，通信对用户透明

**高级通信机制分类**：

1. **共享存储系统**：基于**共享数据结构**或**共享存储区**的通信方式
2. **消息传递服务**：将通信数据封装在**消息**中，利用OS提供的一组通信命令（原语）进行消息传递，目前最流行
   - **直接通信方式**：发送进程利用OS提供的发送原语直接发消息给目标进程
   - **间接通信方式**：发送进程与接收进程通过共享中间体（信箱）进行消息发送与接受
3. **管道通信**：连接一个读进程和一个写进程实现通信的一个共享文件夹（管道）
   - 互斥：一个进程对管道操作其他进程必须等待
   - 同步：当进程把一定数量的数据写入管道后便**睡眠**，知道读进程取走数据后再唤醒
   - 确定对方是否存在：只有确定对方存在才能进行通信
4. 客户机-服务器系统：套接字、远程过程调用和远程方法调用

**消息通信的实现方法**：

1. 直接通信方法：发送进程利用OS所提供的发送命令（原语）直接把消息发送给目标进程
2. 间接通信方法：进程之间使用**信箱**的通信方式
   - **优点**：在**读写时间**上的随机性
   - **邮箱分类**：私有信箱。共有信箱。共享信箱。
   - **关系**：一对一，一对多（广播），多对一（客户/服务器），多对多

### 2.6线程与线程控制

**定义**：进程内的独立执行代码的实体和**调度**单元

**属性**：轻型实体；独立调度和分派的基本单位；可并发执行；共享进程资源

**与进程的区别**

1. **调度**：线程作为**调度和分派**的基本单位；进程作为**资源**拥有的基本单位
2. **并发性**：多个线程之间可并发执行
3. **拥有资源**：线程自己只有一点资源，但是可以访问进程的资源
4. **独立性**：线程必须依赖于进程存在
5. **系统开销**：线程切换、同步和通信都无需**系统内核**的干预
6. **支持多处理机系统**：一个进程分为多个线程分配到**多个处理机**上并行执行，加速

**线程控制块TCB**

- 线程标识符
- 寄存器：PC，PSW，R
- 线程运行状态
- 优先级
- 线程专有存储器
- 信号屏蔽
- 栈指针：核心栈，用户栈

多线程OS中的**进程**属性：

1. 进程是一个可拥有资源的基本单位
2. 多个线程可并发执行
3. 进程已不是可执行的实体

**线程实现方式**

1. **用户级线程**：用户线程仅存在用户空间，对线程的创建、撤销等功能**无需内核**来实现
   - **优点**
     - 线程切换不调用内核
     - 调度是应用程序特定的，可选择不同的调度方法
     - 可运行在任何操作系统上，只需要线程库
   - **缺点**
     - 当线程执行一个系统调用时，该线程机器所属进程内的所有线程都会被阻塞
     - 多线程应用不能利用多处理机进行多重处理
2. **内核支持线程**：无论时用户进程中的线程还是系统进程中的线程，他们的创建、撤销等都是依靠内核完成
   - **优点**
     - **多处理**系统中，内核能同时调度同一进程中的多个线程**并行执行**
     - 如果进程中一个**进程阻塞**，内核可以调度该进程或其他进程中的**其他线程**占有处理器
     - 内核支持线程具有很小的数据结构与堆栈，线程切换**开销小**
     - 内核本身可以采用**多线程技术**，提高效率
   - **缺点**
     - 对于**用户的线程切换开销比较大**，在同一进程中，从一个线程切换到另一个线程需要从**用户态到内核态再到用户态**，因为用户进程的线程在用户态中运行，线程的管理和调度在内核中实现
3. **区别**
   - 用户级线程通过**应用程序**完成线程的创建调度等；内核级线程由**内核**完成
   - 对设置了用户级线程的系统，调度以**进程**为单位；内核级以**进程**为单位

## 3.处理机调度与死锁

**调度目的**：对**CPU资源**进行合理的分配使用，以提高**处理机利用率**，并使各用户**公平**地得到处理机资源

**共同目标**：资源利用率；公平性；平衡性；策略强制执行

### 3.1处理机调度层次

| **调度类型** | 实现                 | **调度对象**         | **主要功能**                                                 | **运行频率**       | **适用系统**                       | **调度目标**                               |
| :----------- | :------------------- | :------------------- | :----------------------------------------------------------- | :----------------- | :--------------------------------- | :----------------------------------------- |
| **高级调度** | 作业管理程序         | 作业                 | 将作业调入内存，创建进程、分配资源并插入就绪队列。           | 几分钟一次（最低） | 多道批处理系统                     | 平衡系统负载，**提高资源利用率**。         |
| **中级调度** | 内存管理中地对换进程 | 挂起进程             | 将暂时不能运行的进程调至外存（挂起），在条件满足时重新调入内存并修改为就绪状态。 | 介于高/低级之间    | 通用系统（需内存对换功能）         | 提高**内存利用率**和**系统吞吐量**。       |
| **低级调度** | 分派程序             | 就绪进程（内核进程） | 从就绪队列中选择进程分配CPU执行，由分派程序完成处理机切换。  | 10ms~100ms（最高） | 多道批处理、分时、实时系统（必需） | 确保**公平性**、**实时性**及系统响应速度。 |

1. **批处理系统目标**
   - **平均周转时间短**：外存队列等待+就绪队列等待+CPU执行时间+等待I/O操作时间
   - **系统吞吐量高**：指单位时间内系统所完成地作业数，选择短作业
   - **处理机利用率高**：选择计算量大的作业
2. **分时系统**
   - **保证响应时间快**：键盘输入+处理+显示
   - **保证均衡性**：系统**响应时间的快慢**应与**用户请求服务的复杂性**相适应
3. **实时系统**
   - **保证满足截止时间的要求**：任务必须开始执行的最迟时间
   - **保证可预测性**

### 3.2作业与作业调度

**作业**：程序+数据+作业说明书

**作业控制块JCB**：保存系统对作业进行管理和调度的全部信息

**作业调度主要任务**：

- 根据JCB中的信息，检查系统中的资源能否**满足作业需求**
- 按照一定的**调度算法**从外存的作业后备队列中选取某些作业**调入内存**，并为它们创建进程和分配必要资源
- 将新创建的进程排在就绪队列上等待调度
  - **接纳多少个作业**：取决于多道程序度，标识允许多少个作业同时在内存中运行
  - **接纳哪些作业**：取决于采用的调度算法

### 3.3调度算法

1. **短作业优先SJF**：
   - **优点**：降低作业平均等待时间；提高吞吐量；缩短进程周转时间
   - **缺点**：必须知道作业的运行时间；对长作业不利；未考虑作业紧迫程度
2. **优先级调度算法**：抢占式与非抢占式
3. **响应比优先**：（等待时间+要求服务时间）/要求服务时间
4. **多级反馈队列调度**：
   - 设置多个就绪队列，每个队列**时间片**递增
   - 每个队列采用FCFS算法
   - 按队列优先级调度

### 3.4实时调度

1. **必要条件**

   - **提供必要信息**
     - 就绪时间：该任务成为就绪状态的起始时间
     - 开始截止时间或完成截至时间
     - 处理时间
     - 资源要求
     - 优先级
   - **系统处理能力强**
     - （处理时间/周期时间）求合小于1
   - **采用抢占式调度机制**
   - **具有快速切换机制**
     - 对外部中断的快速响应能力
     - 快速的任务分派能力

2. **实时调度算法分类**

   - **实时任务性质**：硬实时和软实时

   - **调度方式**：抢占式和非抢占式

   - 非抢占式调度算法：轮转、优先级

     抢占式调度算法：基于**时钟中断**、立即抢占

     最早截至时间优先算法：非抢占式应用于非周期，抢占式应用于周期

     最低松弛度优先算法：松弛度=周期时间-处理时间

     优先级倒置：动态优先级继承，P3占用资源且继承P1优先级别

### 3.5死锁

**定义**：如果一组进程中的每个进程都在等待仅由该组进程中的**其他进程**才能引发的事件发生，那么该组进程是死锁的（不能运行、释放资源、被唤醒）

1. **资源问题**
   - 可重用资源：不允许共享；请求-->使用-->释放；单元数目相对固定（打印机）
   - 消耗性资源：数目变化；允许不断创建；进程与其一对多（消息）
   - 可抢占性资源：CPU；内存
   - 不可抢占资源：打印机、光盘刻录、磁带机
2. **死锁产生原因**
   - 竞争资源：不可抢占资源的竞争、可消耗资源的竞争
   - 进程间推进顺序非法
3. **死锁产生必要条件**
   - 互斥条件：资源非共享，进程互斥
   - 请求和保持条件：进程请求，保持原有资源占用
   - 不可抢占条件：资源不可抢占
   - 循环等待条件：循环依赖
4. **处理方法**
   - 预防死锁
   - 避免死锁
   - 检测死锁
   - 解除死锁

### 3.6预防与避免

**死锁预防**

1. 破坏请求和保持条件
   - 进程在开始运行前需一次性申请全部资源，此后不会再申请
     - 优点：简单、易于实现且安全
     - 缺点：资源被严重浪费
   - 当进程已经保持某些资源，再提出请求而不能被满足时，必须释放已经保持的资源
     - 实现起来**复杂**且要付出很大代价
     - 资源被迫释放可能导致**前期段工作失效**
     - 进程前后两次运行的**信息不连续**
     - 进程执行被**无限推迟**，延长进程周转时间，增加系统开销，降低吞吐量
2. 破坏不可抢占条件：当申请不满足，需要释放已占用资源，全是缺点
3. 破坏循环等待条件
   - **资源按线性排队**：所有进程资源申请必须按照序号递增次序提出
     - 优点：资源利用率和系统吞吐量都有明显改善
     - 缺点：限制新类型设备的增加；
     - 进程使用资源数序与系统规定顺序不同，造成资源浪费；
     - 限制用户简单自主编程

**死锁避免**：银行家算法

1. 限制条件

   - 必须**预先声明**每个进程所需的**资源总量**
   - 进程之间**相互独立**，执行顺序取决于**系统安全**，而非进程间的同步要求
   - 系统必须提供**固定数量的资源**供进程使用

2. 数据结构

   - **可利用资源量**Available：m个元素的数组，每个元素代表可用的资源数
   - **最大需求**Max：n*m矩阵，Max[i,j]表示进程i需要的资源j最大数目
   - **分配矩阵**Allocation：n*m矩阵，表示系统已分配的资源
   - **需求矩阵**：n*m矩阵，表示还需要的资源数

3. 银行家算法

   - 定义Request向量，Request_i[j]=K表示进程i请求K个j资源

   ![image-20250405114518595](操作系统.assets/image-20250405114518595.png)

4. 安全性算法

   - **安全状态**：系统按照某种进程推进顺序，为每个进程**分配其所需的资源**，满足每个进程对**资源的最大需求**，进而使每个进程都可顺利完成的一种系统状态

   - **工作向量**Work：表示系统可提供给进程的各类资源数目，初始化为Available
   - **Finish**：开始时Finish[i]=false;当有足够资源分配给进程时再令其为true

   ![image-20250405114814615](操作系统.assets/image-20250405114814615.png)

   

###  3.7死锁的检测与解除

**死锁定理**：当且仅当系统某状态S所对应的**资源分配图**是**不可完全化简**的，则S是死锁状态

**死锁解除**

1. **剥夺资源**：从其他进程剥夺足够数量资源给死锁
2. **撤销进程**：完全撤销或者逐步撤销